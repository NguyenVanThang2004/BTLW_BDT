@using BTLW_BDT.Models;
@using X.PagedList.Mvc.Core;
@model X.PagedList.IPagedList<SanPham>
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@{
    ViewData["Title"] = "DanhMucSanPham";
    Layout = "~/Areas/Admin/Views/Shared/_LayoutAdmin.cshtml";
}

<h1>Danh Muc San Pham</h1>
<p>@TempData["Messege"]</p>
<p>
    <a asp-action="ThemSanPhamMoi">Thêm</a>
</p>

<a onclick="showHideDiveInsertData('displayForm'); return false;" class="btn btn-primary">Thêm sản phẩm bằng API</a>

<div id="displayForm">
    <form id="formAddProduct" method="post">
        <div class="form-group">
            <label class="control-label">Mã sản phẩm</label>
            <input type="text" class="form-control" id="MaSanPham" />
        </div>
        <div class="form-group">
            <label class="control-label">Tên sản phẩm</label>
            <input type="text" class="form-control" id="TenSanPham" />
        </div>
        <div class="form-group">
            <label class="control-label">Ảnh đại diện</label>
            <input type="text" class="form-control" id="AnhDaiDien" />
        </div>
        <div class="form-group">
            <label class="control-label">Thời gian bảo hành</label>
            <input type="text" class="form-control" id="ThoiGianBaoHanh" />
        </div>
        <div class="form-group">
            <label class="control-label">Số lượng tồn kho</label>
            <input type="text" class="form-control" id="SoLuongTonKho" />
        </div>

        <div class="form-group">
            <label class="control-label">Đơn giá bán gốc</label>
            <input id="DonGiaBanGoc" type="text" class="form-control" />
        </div>
        <div class="form-group">
            <label class="control-label">Đơn giá bán ra</label>
            <input id="DonGiaBanRa" type="text" class="form-control" />
        </div>
        <div class="form-group">
            <label class="control-label">Khuyến mại</label>
            <input id="KhuyenMai" type="text" class="form-control" />
        </div>
        <div class="form-group">
            <label class="control-label">Danh bạ</label>
            <input id="DanhBa" type="text" class="form-control" />
        </div>
        <div class="form-group">
            <label class="control-label">Đèn flash</label>
            <input id="DenFlash" type="text" class="form-control" />
        </div>
        <div class="form-group">
            <label class="control-label">Công nghệ màn hình</label>
            <input id="CongNgheManHinh" type="text" class="form-control" />
        </div>
        <div class="form-group">
            <label class="control-label">Độ sáng tối đa</label>
            <input id="DoSangToiDa" type="text" class="form-control" />
        </div>
        <div class="form-group">
            <label class="control-label">Loại pin</label>
            <input id="LoaiPin" type="text" class="form-control" />
        </div>
        <div class="form-group">
            <label class="control-label">Bảo mật nâng cao</label>
            <input id="BaoMatNangCao" type="text" class="form-control" />
        </div>

        <div class="form-group">
            <label class="control-label">Ghi âm mặc định</label>
            <input id="GhiAmMacDinh" type="text" class="form-control" />
        </div>

        <div class="form-group">
            <label class="control-label">Jack tai nghe</label>
            <input id="JackTaiNghe" type="text" class="form-control" />
        </div>
        <div class="form-group">
            <label class="control-label">Mạng di động</label>
            <input id="MangDiDong" type="text" class="form-control" />
        </div>

        <div class="form-group">
            <label class="control-label">Sim</label>
            <input id="Sim" type="text" class="form-control" />
        </div>
        <div class="form-group">
            <label class="control-label">Mã hãng</label>
            <input id="MaHang" type="text" class="form-control" />
        </div>
        <div class="form-group">
            <label class="control-label">Màn hình</label>
            <input id="ManHinh" type="text" class="form-control" />
        </div>
        <div class="form-group">
            <label class="control-label">Pin</label>
            <input id="Pin" type="text" class="form-control" />
        </div>
        <div class="form-group">
            <label class="control-label">Camera</label>
            <input id="Camera" type="text" class="form-control" />
        </div>
        <div class="form-group">
            <label class="control-label">Kích thước</label>
            <input id="KichThuoc" type="text" class="form-control" />
        </div>
        <div class="form-group">
            <label class="control-label">Chip</label>
            <input id="Chip" type="text" class="form-control" />
        </div>
        <div class="form-group">
            <label class="control-label">Ram</label>
            <input id="RAM" type="text" class="form-control" />
        </div>

        <div class="form-group">
            <input onclick="addANewProduct('https://localhost:7040/api/product/'); return false;" value="Create" class="btn btn-primary" />
        </div>

        <div class="form-group">
            <input onclick="deleteProduct('https://localhost:7040/api/product', $('#MaSanPham').val()); return false;" value="Delete" class="btn btn-primary" />
        </div>
    </form>
</div>


<script type="text/javascript">
    
    function addANewProduct(apiUrl) {
        // Thu thập dữ liệu từ form
        console.log('AAAA:', apiUrl);
        var duLieuSanPham = {
            MaSanPham: $('#MaSanPham').val(),
            TenSanPham: $('#TenSanPham').val(),
            AnhDaiDien: $('#AnhDaiDien').val(),
            ThoiGianBaoHanh: parseInt($('#ThoiGianBaoHanh').val()),
            SoLuongTonKho: parseInt($('#SoLuongTonKho').val()),
            DonGiaBanGoc: parseFloat($('#DonGiaBanGoc').val()),
            DonGiaBanRa: parseFloat($('#DonGiaBanRa').val()),
            KhuyenMai: parseFloat($('#KhuyenMai').val()),
            DanhBa: $('#DanhBa').val(),
            DenFlash: $('#DenFlash').val(),
            CongNgheManHinh: $('#CongNgheManHinh').val(),
            DoSangToiDa: parseInt($('#DoSangToiDa').val()),
            LoaiPin: $('#LoaiPin').val(),
            BaoMatNangCao: $('#BaoMatNangCao').val(),
            GhiAmMacDinh: $('#GhiAmMacDinh').val(),
            JackTaiNghe: $('#JackTaiNghe').val(),
            MangDiDong: $('#MangDiDong').val(),
            Sim: $('#Sim').val(),
            MaHang: $('#MaHang').val(),
            ManHinh: $('#ManHinh').val(),
            Pin: $('#Pin').val(),
            Camera: $('#Camera').val(),
            KichThuoc: $('#KichThuoc').val(),
            Chip: $('#Chip').val(),
            RAM: $('#RAM').val()

        };
        console.log('jQuery version:', $.fn.jquery); // Kiểm tra version jQuery
        console.log('Data being sent:', duLieuSanPham); // Kiểm tra dữ liệu gửi đi
        // Gửi yêu cầu AJAX
        $.ajax({
            type: 'POST',
            url: apiUrl,
            data: JSON.stringify(duLieuSanPham),
            contentType: 'application/json',
            dataType: 'json',
            timeout: 30000,
            success: function (phanHoi) {
                alert('Thêm sản phẩm thành công!');
                window.location.href = 'https://localhost:7244/admin/DanhMucSanPham'; // Chuyển hướng sau khi thêm thành công
            },
            error: function (xhr, status, error) {
                // Log chi tiết thông tin lỗi
                console.log('XHR:', xhr);
                console.log('Status:', status);
                console.log('Error:', error);
                console.log('Response Text:', xhr.responseText);

                // Log dữ liệu gửi đi
                console.log('Dữ liệu gửi đi:', duLieuSanPham);

                // Hiển thị thông báo lỗi chi tiết
                let errorMessage = 'Lỗi khi gọi API:\n';
                errorMessage += 'Status: ' + status + '\n';
                errorMessage += 'Error: ' + error + '\n';

                if (xhr.responseText) {
                    try {
                        // Thử parse responseText nếu là JSON
                        const responseObj = JSON.parse(xhr.responseText);
                        errorMessage += 'Response: ' + JSON.stringify(responseObj, null, 2);
                    } catch (e) {
                        // Nếu không phải JSON thì hiện text gốc
                        errorMessage += 'Response: ' + xhr.responseText;
                    }
                }
                alert(errorMessage);
            }
        });
    }
    function showHideDiveInsertData(activeDiv) {
        if ($(document.getElementById(activeDiv)).is(":visible")) {
            $(document.getElementById(activeDiv)).hide('slow');
        }
        else {
            $(document.getElementById(activeDiv)).show('slow');
        }
    }
    
</script>


<script>
    function deleteProduct(apiUrl, maSanPham) {
        if (confirm('Bạn có chắc chắn muốn xóa sản phẩm này?')) {
            $.ajax({
                url: apiUrl + '/' + maSanPham,
                type: 'DELETE',
                success: function (response) {
                    alert('Xóa sản phẩm thành công!');
                    // Refresh trang hoặc xóa row khỏi table
                    location.reload();
                },
                error: function (xhr, status, error) {
                    console.error('Lỗi:', error);
                    alert('Lỗi khi xóa sản phẩm: ' + error);
                }
            });
        }
    }
</script>










<table class="table">
    <thead>
        <tr class="table-warning">
            <th>
                Mã sản phẩm
            </th>
            <th>
                Tên sản phẩm
            </th>
            <th>
                Ảnh đại diện
            </th>
            <th>
                Thời gian BH
            </th>
            <th>
                SL Tồn kho
            </th>
            <th>
                Đơn giá bán gốc
            </th>
            <th>
                Đơn giá bán ra
            </th>
            <th>
                Khuyến mại
            <th>
                Mã Hãng
            </th>

            <th>
                Màn hình
            </th>
            <th>
                Pin
            </th>
            <th>
                Camera
            </th>
            <th>
                Kích thước
            </th>
            <th>
                Chip
            </th>
            <th>
                Ram
            </th>

            <th>

            </th>
        </tr>
    </thead>
    <tbody>
        @{
            int i = 0;
            string @cls = "table-success";
        }
        @foreach (var item in Model)
        {
            i = i + 1;
            cls = "table-success";
            if (i % 2 == 0)
            {
                cls = "table-primary";
            }
            <tr class="@cls">
                <td>
                    @Html.DisplayFor(modelItem => item.MaSanPham)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.TenSanPham)
                </td>
                <td>
                    <img style="width:50px;height75px" class="img-fluid w-100" src="@Url.Content("~/PhoneImages/anh/" + item.AnhDaiDien)" alt="Product Image">

                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.ThoiGianBaoHanh)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.SoLuongTonKho)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.DonGiaBanGoc)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.DonGiaBanRa)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.KhuyenMai)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.MaHang)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.ManHinh)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.Pin)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.Camera)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.KichThuoc)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.Chip)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.Ram)
                </td>

                <td>
                    <a asp-action="SuaSanPham" asp-route-maSanPham="@item.MaSanPham">Sửa</a>
                    <a asp-action="XoaSanPham" asp-route-maSanPham="@item.MaSanPham">Delete</a>
                </td>
            </tr>
        }
    </tbody>
</table>
@Html.PagedListPager(Model, page => Url.Action("DanhMucSanPham", new { page = page }),
        new X.PagedList.Web.Common.PagedListRenderOptions()
    {
        LiElementClasses = new List<String> { "page-item" },
        PageClasses = new List<String> { "page-link" }
    })
