@model IEnumerable<BTLW_BDT.Models.KhachHang>
@{
    ViewData["Title"] = "Chat Support";
    Layout = "~/Areas/Admin/Views/Shared/_LayoutAdmin.cshtml";
}

<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>
<div class="container-fluid">
    <div class="row">
        <!-- Danh sách người dùng -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header pb-0 p-3">
                    <h6 class="mb-0">Danh sách người dùng</h6>
                </div>
                <div class="card-body p-3">
                    <div class="user-list" style="height: 600px; overflow-y: auto;">
                        @foreach (var customer in Model)
                        {
                            <div class="user-item d-flex align-items-center p-2 border-bottom" 
                                 data-customer-id="@customer.MaKhachHang"
                                 onclick="selectCustomer('@customer.MaKhachHang', '@customer.TenKhachHang')">
                                <img src="@(customer.AnhDaiDien ?? "/Images/Customer/default-avatar.jpg")" class="avatar avatar-sm me-3">
                                <div class="d-flex flex-column">
                                    <h6 class="mb-1 text-sm">@customer.TenKhachHang</h6>
                                    @if (customer.LastMessage != null)
                                    {
                                        <span class="text-xs">@customer.LastMessage.NoiDung</span>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Khung chat -->
        <div class="col-md-8">
            <div class="card">
                <div class="card-header pb-0 p-3">
                    <div class="d-flex align-items-center">
                        <img src="~/Images/Customer/default-avatar.jpg" class="avatar avatar-sm me-3">
                        <h6 class="mb-0">Khách hàng 1</h6>
                    </div>
                </div>
                <div class="card-body p-3">
                    <!-- Khung chat -->
                    <div class="chat-messages" id="messagesList" style="height: 500px; overflow-y: auto;">
                        <!-- Tin nhắn sẽ được thêm vào đây -->
                    </div>

                    <!-- Input chat -->
                    <div class="chat-input mt-3">
                        <div class="input-group">
                            <input type="text" id="messageInput" class="form-control" placeholder="Nhập tin nhắn...">
                            <button class="btn btn-primary mb-0" id="sendButton">
                                <i class="material-icons">send</i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .user-item {
        cursor: pointer;
        transition: all 0.3s;
    }

    .user-item:hover {
        background-color: #f8f9fa;
    }

    .active-chat {
        background-color: #e9ecef;
    }

    .chat-messages {
        padding: 1rem;
    }

    .message {
        margin-bottom: 1rem;
        max-width: 80%;
    }

    .message.received {
        margin-right: auto;
    }

    .message.sent {
        margin-left: auto;
    }

    .message-content {
        padding: 0.75rem 1rem;
        border-radius: 1rem;
    }

    .message.received .message-content {
        background-color: #f8f9fa;
    }

    .message.sent .message-content {
        background-color: #7b809a;
        color: white;
    }

    .message-time {
        font-size: 0.75rem;
        color: #6c757d;
        margin-top: 0.25rem;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        var connection = new signalR.HubConnectionBuilder()
            .withUrl("/chatHub")
            .withAutomaticReconnect()
            .configureLogging(signalR.LogLevel.Information)
            .build();

        // Xử lý nhận tin nhắn
        connection.on("ReceiveMessage", function (loaiNguoiGui, message, thoiGian) {
            const messageDiv = document.createElement("div");
            messageDiv.className = `message ${loaiNguoiGui === 'admin' ? 'sent' : 'received'}`;
            
            messageDiv.innerHTML = `
                <div class="message-content">${message}</div>
                <div class="message-time">${new Date(thoiGian).toLocaleTimeString()}</div>
            `;
            
            document.getElementById("messagesList").appendChild(messageDiv);
            messageDiv.scrollIntoView({ behavior: "smooth" });
        });

        // Xử lý load lịch sử tin nhắn
        connection.on("LoadMessageHistory", function (messages) {
            const messagesList = document.getElementById("messagesList");
            messagesList.innerHTML = '';
            
            messages.forEach(msg => {
                const messageDiv = document.createElement("div");
                messageDiv.className = `message ${msg.loaiNguoiGui === 'admin' ? 'sent' : 'received'}`;
                
                messageDiv.innerHTML = `
                    <div class="message-content">${msg.noiDung}</div>
                    <div class="message-time">${new Date(msg.thoiGian).toLocaleTimeString()}</div>
                `;
                
                messagesList.appendChild(messageDiv);
            });
            
            messagesList.scrollTop = messagesList.scrollHeight;
        });

        // Xử lý gửi tin nhắn
        document.getElementById("sendButton").addEventListener("click", async function() {
            const messageInput = document.getElementById("messageInput");
            const message = messageInput.value.trim();
            const currentCustomerId = "current-customer-id"; // Cần thay đổi để lấy ID của khách hàng đang chat

            if (message) {
                try {
                    await connection.invoke("SendMessage", message, currentCustomerId);
                    messageInput.value = '';
                } catch (err) {
                    console.error(err);
                }
            }
        });

        // Bắt đầu kết nối
        async function startConnection() {
            try {
                await connection.start();
                console.log("SignalR Connected.");
                
                // Load tin nhắn sau khi kết nối thành công
                const currentCustomerId = "current-customer-id"; // Cần thay đổi để lấy ID của khách hàng đang chat
                await connection.invoke("LoadMessages", currentCustomerId);
            } catch (err) {
                console.log(err);
                setTimeout(startConnection, 5000);
            }
        }

        startConnection();
    });

    function selectCustomer(customerId, customerName) {
        // Cập nhật UI
        document.querySelector('.card-header h6').textContent = customerName;
        
        // Xóa class active-chat cũ
        document.querySelector('.active-chat')?.classList.remove('active-chat');
        
        // Thêm class active-chat mới
        event.currentTarget.classList.add('active-chat');
        
        // Load tin nhắn của khách hàng được chọn
        connection.invoke("LoadMessages", customerId);
        
        // Lưu customerId hiện tại
        currentCustomerId = customerId;
    }
</script>